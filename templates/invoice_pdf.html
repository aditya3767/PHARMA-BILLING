<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shree Samarth Enterprises - Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #1a73e8;
            --accent: #e67e22;
            --light: #f8f9fa;
            --dark: #2d3436;
            --success: #27ae60;
            --success-dark: #1e8449;
            --danger: #e74c3c;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        header {
            background: white;
            color: var(--dark);
            padding: 25px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill-opacity="0.05" fill="white" width="50" height="50" /><rect fill-opacity="0.05" fill="white" x="50" y="50" width="50" height="50" /></svg>');
            background-size: 100px;
        }

        .app-title {
            font-family: 'Cinzel', serif;
            font-size: 38px;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 2px;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #f8d568, #f4c531, #f8d568);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 5px;
        }

        .app-subtitle {
            font-size: 16px;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .content-row {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }

        .edit-frame {
            width: 250px;
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            align-self: flex-start;
        }

        .preview-section {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 30px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary);
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 5px;
        }

        button:hover {
            background: #1557b7;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .generate-pdf {
            background: var(--accent);
            padding: 25px;
            font-size: 20px;
            justify-content: center;
        }

        .generate-pdf:hover {
            background: #d35400;
        }

        .send-mail {
            background: var(--success);
            padding: 25px;
            font-size: 20px;
            justify-content: center;
        }

        .send-mail:hover {
            background: var(--success-dark);
        }

        .btn-back {
            font-size: 20px;
            background: var(--dark);
        }

        .btn-back:hover {
            background: #1a252f;
        }

        #bill-preview {
            background: white;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius);
            flex: 1;
            overflow: auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        #bill-preview .company-header {
            text-align: center;
            margin-bottom: 10px;
            position: relative;
            padding-bottom: 1px;
            border-bottom: 2px solid #eee;
        }

        #bill-preview .company-name {
            font-family: 'Cinzel', serif;
            font-size: 40px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: -17px;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 5px;
            position: relative;
            display: inline-block;
        }

        #bill-preview .company-address {
            font-size: 16px;
            color: #666;
            margin-bottom: 0px;
        }

        #bill-preview .contact-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 16px;
            color: var(--secondary);
            font-weight: 500;
        }

        #bill-preview .bill-details {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            gap: 10px;
            flex-wrap: wrap;
        }

        #bill-preview .customer-details, #bill-preview .bill-info {
            flex: 1;
            padding: 8px;
            border-radius: var(--radius);
            background: #f8f9fa;
            font-size: 18px;
        }

        #bill-preview .detail-title {
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 1px;
            font-size: 18px;
        }

        #bill-preview table {
            width: 100%;
            border-collapse: collapse;
            margin: -9.5px 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            border-radius: var(--radius);
            overflow: hidden;
        }

        #bill-preview th, #bill-preview td {
            padding: 4px 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 16px;
            min-height: 24px; /* Matches the approximate height of product rows */
            line-height: 22px; /* Ensures consistent height */
        }

        #bill-preview th {
            background-color: var(--secondary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 15px;
        }

        #bill-preview tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        #bill-preview tr:hover {
            background-color: #edf2f7;
        }

        #bill-preview .total-row {
            font-weight: 700;
            background-color: #e8f4fc;
            font-size: 18px;
        }

        #bill-preview .note {
            font-style: italic;
            color: #666;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            font-size: 16px;
        }

        #bill-preview .signature-area {
            display: flex;
            justify-content: flex-end;
            margin: 10px 0;
        }

        #bill-preview .signature-box {
            flex: 0 0 40%;
            text-align: center;
            padding: 5px;
        }

        #bill-preview .signature-line {
            width: 70%;
            height: 1px;
            background: #ccc;
            margin: -3px auto 3px;
            position: relative;
        }

        #bill-preview .signature-line::after {
            content: "Auth Signatory";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: #777;
            font-size: 12px;
        }

        #bill-preview .thankyou-section {
            text-align: center;
            margin: 10px 0;
            font-size: 20px;
            color: var(--primary);
        }

        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 80px;
            font-weight: 400;
            color: var(--primary);
            pointer-events: none;
            white-space: nowrap;
            transform: rotate(-45deg) translateY(0);
            font-family: 'Playfair Display', serif;
            top: 55%;
            left: 40%;
            margin-top: -10px;
            margin-left: -300px;
            width: 620px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .toggle-label {
            font-weight: 500;
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--secondary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 600px) {
            .content-row {
                flex-direction: column;
            }

            .bill-details {
                flex-direction: column;
            }

            .contact-info {
                flex-direction: column;
                gap: 10px;
            }

            .signature-area {
                flex-direction: column;
                gap: 20px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="app-title"><i class="fas fa-receipt"></i> Shree Samarth Enterprises</h1>
            <p class="app-subtitle">Billing & Invoicing Software</p>
        </header>

        <div class="content-row">
            <div class="edit-frame">
                <h2 class="section-title"><i class="fas fa-edit"></i> Edit Entry</h2>
                <div class="form-group">
                    <label for="row-select">Select Row:</label>
                    <select id="row-select" onchange="loadRowData()">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-scheme">Scheme:</label>
                    <input type="number" id="edit-scheme" oninput="updateRow()">
                </div>
                <div class="form-group">
                    <label for="edit-batch">Batch No.:</label>
                    <input type="text" id="edit-batch" oninput="updateRow()">
                </div>
                <div class="form-group">
                    <label for="edit-expiry">Expiry:</label>
                    <input type="date" id="edit-expiry" oninput="updateRow()">
                </div>
                <div class="form-group">
                    <label for="show-additional-discount">Add Additional Discount:</label>
                    <input type="checkbox" id="show-additional-discount" onchange="toggleAdditionalDiscount()">
                </div>
                <div class="form-group" id="additional-discount-group" style="display: none;">
                    <label for="edit-additional-discount">Additional Discount (%):</label>
                    <input type="number" step="0.1" id="edit-additional-discount" oninput="updateRow()">
                </div>
            </div>

            <div class="preview-section">
                <h2 class="section-title"><i class="fas fa-file-pdf"></i> Bill Preview</h2>
                <div id="bill-preview"></div>

                <div class="action-buttons">
                    <button class="generate-pdf" onclick="generatePDF()">
                        <i class="fas fa-file-download"></i> Generate PDF Bill
                    </button>
                    <button class="generate-pdf send-mail" onclick="sendMailDemo()">
                        <i class="fas fa-envelope"></i> Sent Mail
                    </button>
                    <button class="btn-back" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Billing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get bill data from Flask template variable with error handling
        let billData = null;
        try {
            // Use a placeholder for bill_data to avoid syntax errors if not provided
            billData = JSON.parse('{{ bill_data | tojson | safe }}' || '{}');
            if (!billData || typeof billData !== 'object' || Object.keys(billData).length === 0) {
                throw new Error('Invalid or empty bill data');
            }
        } catch (e) {
            console.error('Error parsing billData:', e);
            billData = null;
        }

        let items = [];
        let invoiceNo = Math.floor(100 + Math.random() * 900);

        // Initialize the page with bill data
        document.addEventListener('DOMContentLoaded', function() {
            if (billData && Object.keys(billData).length > 0) {
                initializeBillPreview(billData);
            } else {
                // If no bill data, show error and redirect back after 3 seconds
                const billPreview = document.getElementById('bill-preview');
                billPreview.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #e74c3c;">No bill data found</h2>
                        <p>Redirecting you back to the billing page...</p>
                    </div>
                `;
                console.error('Bill data is missing or invalid');
                setTimeout(() => {
                    window.history.back();
                }, 3000);
            }
        });

        function initializeBillPreview(data) {
            // Format date
            const formattedDate = new Date(data.billDate).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Prepare items array with defaults
            items = (data.items || []).map(item => {
                // Apply a 20% discount by default to calculate the base rate
                const rate = item.price * 0.8;
                const amount = item.quantity * rate;
                return {
                    ...item,
                    mfg: 'WDPL',
                    scheme: '',
                    baseDiscount: 20, // Default 20% discount
                    additionalDiscount: 0, // New additional discount initialized to 0
                    showAdditionalDiscount: false, // Flag to show/hide the field
                    batch: 'N/A',
                    rate: rate,
                    amount: amount
                };
            });

            // Populate row select
            populateSelect();

            // Render table
            renderTable(formattedDate);
        }

        function populateSelect() {
            const select = document.getElementById('row-select');
            select.innerHTML = '<option value="">-- Select --</option>';
            items.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = `${index + 1} - ${item.name}`;
                select.appendChild(opt);
            });
        }

        function loadRowData() {
            const select = document.getElementById('row-select');
            const index = select.value;
            if (index === '') return;
            const item = items[index];
            document.getElementById('edit-scheme').value = item.scheme;
            document.getElementById('edit-batch').value = item.batch;
            document.getElementById('edit-expiry').value = item.expiry || '';
            document.getElementById('show-additional-discount').checked = item.showAdditionalDiscount;
            document.getElementById('edit-additional-discount').value = item.additionalDiscount > 0 ? item.additionalDiscount : '';
            toggleAdditionalDiscount();
        }

        function toggleAdditionalDiscount() {
            const checkbox = document.getElementById('show-additional-discount');
            const discountGroup = document.getElementById('additional-discount-group');
            const select = document.getElementById('row-select');
            const index = select.value;

            discountGroup.style.display = checkbox.checked ? 'block' : 'none';

            if (index !== '') {
                const item = items[index];
                item.showAdditionalDiscount = checkbox.checked;

                // If checkbox is unchecked, reset the additional discount to 0
                if (!checkbox.checked) {
                    item.additionalDiscount = 0;
                    document.getElementById('edit-additional-discount').value = '';
                }

                updateRow();
            }
        }

        function updateRow() {
            const select = document.getElementById('row-select');
            const index = select.value;
            if (index === '') return;
            const item = items[index];

            // Update product details
            const schemeValue = document.getElementById('edit-scheme').value;
            item.scheme = schemeValue === '' ? '' : parseInt(schemeValue) || '';
            item.batch = document.getElementById('edit-batch').value;
            item.expiry = document.getElementById('edit-expiry').value;

            // Recalculate rate based on the default 20% discount
            item.rate = item.price * (1 - item.baseDiscount / 100);

            // Update and apply the additional discount if shown
            if (item.showAdditionalDiscount) {
                const additionalDiscountInput = document.getElementById('edit-additional-discount').value;
                item.additionalDiscount = additionalDiscountInput === '' ? 0 : parseFloat(additionalDiscountInput) || 0;
            } else {
                item.additionalDiscount = 0;
            }

            // Calculate the amount value AFTER applying the additional discount
            let tempAmount = item.quantity * item.rate;
            item.amount = tempAmount * (1 - item.additionalDiscount / 100);

            // Re-render table
            const formattedDate = new Date(billData.billDate).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            renderTable(formattedDate);
        }

        // Function to format currency without trailing zeros
        function formatCurrency(value) {
            const num = Number(value);
            return `₹${num % 1 === 0 ? num.toString() : num.toFixed(2)}`;
        }

        function renderTable(formattedDate) {
            let productsHTML = '';
            let total = 0;

            // Determine number of blank rows based on item count
            let blankRows = 0;
            if (items.length === 1) {
                blankRows = 4;
            } else if (items.length === 2) {
                blankRows = 3;
            } else if (items.length === 3) {
                blankRows = 2;
            } else if (items.length === 4) {
                blankRows = 1;
            } else if (items.length >= 5) {
                blankRows = 0;
            }

            items.forEach(item => {
                // Format expiry date to MM/YYYY
                const expiryDate = item.expiry ? new Date(item.expiry).toLocaleDateString('en-IN', {
                    month: '2-digit',
                    year: 'numeric'
                }) : 'N/A';
                const schemeDisplay = item.scheme === '' ? '' : (item.scheme > 0 ? '+' + item.scheme : item.scheme);
                const discountDisplay = item.additionalDiscount > 0 ? item.additionalDiscount.toFixed(1) + '%' : '';
                const amount = item.amount;
                total += amount;

                productsHTML += `
                    <tr>
                        <td>${item.mfg}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${schemeDisplay}</td>
                        <td>${item.size}</td>
                        <td>${item.batch}</td>
                        <td>${expiryDate}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.rate)}</td>
                        <td>${discountDisplay}</td>
                        <td>${formatCurrency(amount)}</td>
                    </tr>
                `;
            });

            // Add blank rows with &nbsp; to enforce consistent height
            for (let i = 0; i < blankRows; i++) {
                productsHTML += `
                    <tr class="blank-row">
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                `;
            }

            // Update the bill preview
            const billPreview = document.getElementById('bill-preview');
            billPreview.innerHTML = `
                <div class="watermark">SHREE SAMARTH ENTERPRISES</div>
                <div class="company-header">
                    <div class="company-name">Shree Samarth Enterprises</div>
                    <div class="company-address">H.No. 248, Varachi Ali, AT Kamba, Post Varap, Taluka Kalyan 421301, Dist. Thane</div>
                    <div class="contact-info">
                        <div id="page-marker" style="font-style: italic; color: #666; font-size: 14px;"></div>
                        <div style="display: flex; align-items: center; gap: 5px;">Phone: 7057710099</div>
                    </div>
                </div>

                <div class="bill-details">
                    <div class="customer-details">
                        <div class="detail-title">Customer Details</div>
                        <div><strong>Name:</strong> ${billData?.customerName || 'N/A'}</div>
                        <div><strong>Address:</strong> ${billData?.customerAddress || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${billData?.customerPhone || 'N/A'}</div>
                        <div><strong>GSTIN:</strong> ${billData?.gstNo || 'N/A'}</div>
                        <div><strong>PAN:</strong> ${billData?.panNo || 'N/A'}</div>
                    </div>

                    <div class="bill-info">
                        <div class="detail-title">Bill Information</div>
                        <div><strong>Invoice No:</strong> ${invoiceNo}</div>
                        <div><strong>Date:</strong> ${formattedDate}</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>MFG</th>
                            <th>Product Name</th>
                            <th>Qty</th>
                            <th>Fr/Sch</th>
                            <th>Pack</th>
                            <th>Batch No.</th>
                            <th>Exp</th>
                            <th>MRP</th>
                            <th>Rate</th>
                            <th>Dis%</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productsHTML}
                        <tr class="total-row">
                            <td colspan="10" style="text-align: right;">Total Amount:</td>
                            <td>${formatCurrency(total)}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="note">
                    <strong>Please Note:</strong> Goods once sold will not be taken back.
                </div>

                <div class="signature-area">
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <p>FOR SHREE SAMARTH ENTERPRISES</p>
                    </div>
                </div>
            `;
        }

        // Generate PDF function with error handling and server-side saving
        function generatePDF() {
            try {
                const element = document.getElementById('bill-preview');
                if (!element) {
                    console.error("Bill preview element not found");
                    alert("Error: Bill preview section is missing");
                    return;
                }

                const marker = document.getElementById('page-marker');
                if (!marker) {
                    console.error("Page marker not found");
                    alert("Error: Page marker element is missing");
                    return;
                }

                const options = {
                    scale: 3,
                    useCORS: true,
                    logging: false,
                    image: { type: 'jpeg', quality: 0.95 }
                };

                const pdf = new jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const imgWidth = 210;
                const pageHeight = 297;

                // Get today's date automatically (YYYY-MM-DD format)
                const today = new Date().toISOString().split('T')[0];
                const folderPath = `shree_samarth_enterprises_bills/${today}`;
                const filename = `${invoiceNo}_shree_samarth_enterprises.pdf`;

                // Original
                marker.textContent = '(Original)';
                html2canvas(element, options).then(canvas1 => {
                    const imgData1 = canvas1.toDataURL('image/jpeg', 0.95);
                    const imgHeight1 = (canvas1.height * imgWidth) / canvas1.width;
                    let heightLeft1 = imgHeight1;
                    let position1 = 0;

                    pdf.addImage(imgData1, 'JPEG', 0, position1, imgWidth, imgHeight1, '', 'MEDIUM');
                    heightLeft1 -= pageHeight;

                    while (heightLeft1 >= 0) {
                        position1 = heightLeft1 - imgHeight1;
                        pdf.addPage();
                        pdf.addImage(imgData1, 'JPEG', 0, position1, imgWidth, imgHeight1, '', 'MEDIUM');
                        heightLeft1 -= pageHeight;
                    }

                    // Duplicate
                    marker.textContent = '(Duplicate)';
                    return html2canvas(element, options);
                }).then(canvas2 => {
                    const imgData2 = canvas2.toDataURL('image/jpeg', 0.95);
                    const imgHeight2 = (canvas2.height * imgWidth) / canvas2.width;
                    pdf.addPage();
                    let heightLeft2 = imgHeight2;
                    let position2 = 0;

                    pdf.addImage(imgData2, 'JPEG', 0, position2, imgWidth, imgHeight2, '', 'MEDIUM');
                    heightLeft2 -= pageHeight;

                    while (heightLeft2 >= 0) {
                        position2 = heightLeft2 - imgHeight2;
                        pdf.addPage();
                        pdf.addImage(imgData2, 'JPEG', 0, position2, imgWidth, imgHeight2, '', 'MEDIUM');
                        heightLeft2 -= pageHeight;
                    }

                    // Save updated bill data to reports (MongoDB)
                    const updatedBillData = {
                        invoice_no: invoiceNo,
                        date: billData?.billDate || new Date().toISOString(),
                        customer_name: billData?.customerName || 'N/A',
                        customer_address: billData?.customerAddress || 'N/A',
                        customer_phone: billData?.customerPhone || 'N/A',
                        gst_no: billData?.gstNo || 'N/A',
                        pan_no: billData?.panNo || 'N/A',
                        items: items,
                        total_amount: items.reduce((sum, item) => sum + item.amount, 0)
                    };

                    fetch('/api/save_bill', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedBillData)
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log('Bill saved for reports:', data);
                    })
                    .catch(err => console.error('Error saving bill for reports:', err));

                    // Output PDF as blob and send to server for saving
                    const pdfBlob = pdf.output('blob');
                    const formData = new FormData();
                    formData.append('pdf', pdfBlob, filename);
                    formData.append('folderPath', folderPath);

                    fetch('/save_invoice_pdf', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('PDF saved to server:', data);
                        if (data.status === 'success') {
                            alert('PDF saved successfully to project directory: ' + folderPath);
                        } else {
                            console.error('Server save failed:', data);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving PDF to server:', error);
                        alert('Failed to save PDF to server, but downloading locally.');
                    })
                    .finally(() => {
                        pdf.save(filename);
                    });
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                    alert("Failed to generate PDF. Please check the console for details.");
                });
            } catch (error) {
                console.error("Error in generatePDF:", error);
                alert("An error occurred while generating the PDF.");
            }
        }

        function sendMailDemo() {
            alert('Email sent demo!');
        }
    </script>
</body>
</html>