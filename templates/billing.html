<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBill - Pharmacy Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --primary-light: #e8f0fe;
            --secondary: #6c5ce7;
            --accent: #ffc107;
            --success: #0f9d58;
            --danger: #ea4335;
            --warning: #f39c12;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --sidebar-width: 280px;
            --header-height: 80px;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            z-index: 1000;
            transition: var(--transition);
        }

        .logo {
            text-align: center;
            padding: 25px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo span {
            color: var(--accent);
            font-weight: 800;
        }

        .logo p {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .menu-item {
            padding: 16px 25px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            margin: 4px 12px;
            border-radius: 8px;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent);
        }

        .menu-item i {
            margin-right: 15px;
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item span {
            font-weight: 500;
            font-size: 15px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            background: var(--white);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            height: var(--header-height);
            z-index: 100;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            margin: 0 auto;
            flex: 1;
            max-width: 600px;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--light);
            border-radius: 50px;
            padding: 12px 20px;
            width: 100%;
            position: relative;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .search-bar:focus-within {
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1);
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 5px 5px 5px 15px;
            font-size: 16px;
            color: var(--dark);
        }

        .clear-search {
            position: absolute;
            right: 15px;
            cursor: pointer;
            color: var(--gray);
            display: none;
            background: var(--light-gray);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .clear-search:hover {
            background: var(--gray);
            color: var(--white);
        }

        .search-icon {
            color: var(--gray);
        }

        .category-filter {
            margin-left: 12px;
            position: relative;
        }

        .category-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
        }

        .category-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            display: none;
            width: 200px;
            margin-top: 8px;
            overflow: hidden;
        }

        .category-dropdown.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .category-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--light-gray);
            font-weight: 500;
        }

        .category-option:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .category-option:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }

        .user-info .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 20px;
            font-weight: 600;
            margin-right: 12px;
        }

        .user-info h4 {
            font-weight: 600;
            color: var(--dark);
        }

        .user-info p {
            color: var(--gray);
            font-size: 13px;
        }

        /* Content Area Styles */
        .content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 24px;
            margin-bottom: 30px;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--light-gray);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 22px;
        }

        .stats-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .stats-badge:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* Customer Details Styles */
        .customer-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .customer-row {
            grid-column: span 3;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 16px;
            transition: var(--transition);
            background: var(--light);
        }

        .form-control.uppercase {
            text-transform: uppercase;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1);
            outline: none;
            background: var(--white);
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(15, 157, 88, 0.3);
        }

        .btn-success:hover {
            background: #0c8044;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(15, 157, 88, 0.4);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(23, 162, 184, 0.4);
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--primary-light);
            font-weight: 700;
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        tr {
            transition: var(--transition);
        }

        tr:hover {
            background-color: #f9f9f9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
        }

        .stock-expiry {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expiry-date {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 50px;
            font-weight: 600;
        }

        .expiry-valid {
            background: #e6f7ee;
            color: var(--success);
        }

        .expiry-warning {
            background: #fef5e7;
            color: var(--warning);
        }

        .expiry-danger {
            background: #fde8e8;
            color: var(--danger);
        }

        /* Total Amount Section */
        .total-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .total-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--border-radius);
            padding: 24px;
            width: 350px;
            color: var(--white);
            box-shadow: var(--box-shadow);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .total-label {
            font-weight: 500;
            font-size: 16px;
        }

        .total-value {
            font-weight: 700;
            font-size: 16px;
        }

        .final-total {
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            padding-top: 16px;
            margin-top: 16px;
            font-size: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 50%;
            box-shadow: var(--box-shadow);
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .close {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close:hover {
            color: var(--dark);
        }

        .pricing-field {
            display: flex;
            margin-bottom: 15px;
            gap: 12px;
            align-items: center;
        }

        .rupee-symbol::before {
            content: "₹";
        }

        /* Variant Selection Modal */
        .variant-modal {
            display: none;
            position: fixed;
            z-index: 1101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .variant-modal-content {
            background-color: var(--white);
            margin: 10% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
        }

        .variant-option {
            padding: 15px;
            margin: 8px 0;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .variant-option:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .quantity-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Category Selection Modal */
        .category-modal {
            display: none;
            position: fixed;
            z-index: 1102;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .category-modal-content {
            background-color: var(--white);
            margin: 15% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
        }

        .category-modal-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            font-weight: 600;
        }

        .category-modal-option:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Size Selection Modal */
        .size-modal {
            display: none;
            position: fixed;
            z-index: 1103;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .size-modal-content {
            background-color: var(--white);
            margin: 15% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
        }

        .size-modal-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            font-weight: 600;
        }

        .size-modal-option:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Size Input Container */
        .size-input-container {
            position: relative;
            flex: 1;
        }

        .size-unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            pointer-events: none;
            font-weight: 600;
        }

        .size-input {
            padding-right: 50px;
            width: 100%;
        }

        /* Customer Selection Dropdown */
        .customer-dropdown {
            position: absolute;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            display: none;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .customer-dropdown.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .customer-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--light-gray);
        }

        .customer-option:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .customer-option:last-child {
            border-bottom: none;
        }

        /* Inbox Styles */
        .inbox-container {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 400px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1104;
            display: none;
            max-height: 500px;
            overflow-y: auto;
            animation: slideInRight 0.3s ease;
        }

        .inbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--primary);
            color: var(--white);
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }

        .inbox-title {
            font-size: 18px;
            font-weight: 700;
        }

        .inbox-close {
            cursor: pointer;
            font-size: 22px;
            transition: var(--transition);
        }

        .inbox-close:hover {
            transform: rotate(90deg);
        }

        .inbox-content {
            padding: 20px;
            height: 100%;
        }

        .notification-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid;
            transition: var(--transition);
        }

        .notification-critical {
            background: #fde8e8;
            border-left-color: var(--danger);
        }

        .notification-high {
            background: #fef5e7;
            border-left-color: var(--warning);
        }

        .notification-medium {
            background: #e1f5fe;
            border-left-color: var(--info);
        }

        .notification-low {
            background: #e6f7ee;
            border-left-color: var(--success);
        }

        .notification-date {
            font-size: 12px;
            color: var(--gray);
            margin-top: 8px;
        }

        /* Manual Edit Styles */
        .manual-edit-btn {
            background: var(--warning);
            color: var(--white);
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-left: 5px;
            transition: var(--transition);
        }

        .manual-edit-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        /* Inbox Toggle Button */
        .inbox-toggle {
            position: fixed;
            top: 100px;
            right: 30px;
            background: var(--primary);
            color: var(--white);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            z-index: 1103;
            transition: var(--transition);
        }

        .inbox-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .inbox-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: var(--white);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Stats Modal */
        .stats-modal {
            display: none;
            position: fixed;
            z-index: 1105;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .stats-modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Modal Scrollbar */
        .modal-content::-webkit-scrollbar,
        .variant-modal-content::-webkit-scrollbar,
        .category-modal-content::-webkit-scrollbar,
        .size-modal-content::-webkit-scrollbar,
        .stats-modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-thumb,
        .variant-modal-content::-webkit-scrollbar-thumb,
        .category-modal-content::-webkit-scrollbar-thumb,
        .size-modal-content::-webkit-scrollbar-thumb,
        .stats-modal-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        /* Clear Button Visibility Fix */
        .search-bar .clear-search {
            display: flex;
            opacity: 0.7;
        }

        .search-bar .clear-search:hover {
            opacity: 1;
        }

        /* Medicine Form Improvements */
        .medicine-form-group {
            margin-bottom: 20px;
        }

        .medicine-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .customer-details, .customer-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                z-index: 1000;
                padding: 10px 0;
            }
            .logo {
                display: none;
            }
            .menu-items {
                display: flex;
                overflow-x: auto;
            }
            .menu-item {
                flex-direction: column;
                padding: 12px;
                margin: 4px;
                min-width: 80px;
            }
            .menu-item i {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }
            .menu-item span {
                font-size: 12px;
            }
            .main-content {
                margin-bottom: 80px;
            }
            .customer-details, .customer-row {
                grid-template-columns: 1fr;
            }
            .search-bar {
                width: 100%;
            }
            .modal-content {
                width: 90%;
            }
            .total-card {
                width: 100%;
            }
            .inbox-container {
                width: 90%;
                right: 5%;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }
            .search-container {
                width: 100%;
            }
            .user-info {
                margin-left: 0;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .stats-modal-content {
                width: 95%;
            }
            .pricing-field {
                flex-direction: column;
            }
        }
    </style>
</head>
<body onload="initializeApp()">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>Medi<span>Bill</span></h1>
                <p>Pharmacy Management System</p>
            </div>
            <div class="menu-items">
                <div class="menu-item active" onclick="selectMenu('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" onclick="selectMenu('inventory')">
                    <i class="fas fa-pills"></i>
                    <span>Inventory</span>
                </div>
                <div class="menu-item" onclick="selectMenu('profit')">
                    <i class="fas fa-receipt"></i>
                    <span>Profit</span>
                </div>
                <div class="menu-item" onclick="selectMenu('reports')">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </div>
                <div class="menu-item" onclick="selectMenu('logout')">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-container">
                    <div class="search-bar">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="medicineSearch" placeholder="Search medicine..." onkeyup="searchMedicine()">
                        <span class="clear-search" id="clearSearch" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                    <div class="category-filter">
                        <button class="category-btn" onclick="toggleCategoryDropdown()">
                            <i class="fas fa-filter"></i> Category
                        </button>
                        <div class="category-dropdown" id="categoryDropdown">
                            <div class="category-option" onclick="filterByCategory('all')">All Categories</div>
                            <div class="category-option" onclick="filterByCategory('ml/Ltr')">ml/Ltr</div>
                            <div class="category-option" onclick="filterByCategory('gm/Kg')">gm/Kg</div>
                            <div class="category-option" onclick="filterByCategory('Tab')">Tablets</div>
                            <div class="category-option" onclick="filterByCategory('Cap')">Capsules</div>
                        </div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="avatar">VB</div>
                    <div>
                        <h4>Vilas Bhoir</h4>
                        <p>Pharmacist</p>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Customer Details -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-user-circle"></i> Customer Details</h2>
                    </div>
                    <div class="customer-details">
                        <div class="customer-row">
                            <div class="form-group">
                                <label for="customerName">Name</label>
                                <input type="text" id="customerName" class="form-control" placeholder="ENTER CUSTOMER NAME" onfocus="filterCustomerDropdown()">
                                <div class="customer-dropdown" id="customerDropdown">
                                    <!-- Customer options will be populated dynamically -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="customerAddress">Address</label>
                                <input type="text" id="customerAddress" class="form-control" placeholder="ENTER ADDRESS">
                            </div>
                            <div class="form-group">
                                <label for="customerPhone">Phone No.</label>
                                <input type="text" id="customerPhone" class="form-control" placeholder="ENTER PHONE NUMBER">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="gstNo">GSTIN No.</label>
                            <input type="text" id="gstNo" class="form-control uppercase" placeholder="Enter GSTIN No." oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div class="form-group">
                            <label for="panNo">PAN No.</label>
                            <input type="text" id="panNo" class="form-control uppercase" placeholder="Enter PAN No." oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div class="form-group">
                            <label for="billDate">Date</label>
                            <input type="date" id="billDate" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Medicine Search Results -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-pills"></i> Medicine Inventory</h2>
                        <div>
                            <div class="stats-badge" onclick="showStatsModal()">
                                <i class="fas fa-chart-bar"></i>
                                <span id="medicineCount">0</span> Medicines
                            </div>
                            <button class="btn btn-primary" onclick="openAddMedicineModal()">
                                <i class="fas fa-plus"></i> Add New Medicine
                            </button>
                        </div>
                    </div>
                    <table id="medicineTable">
                        <thead>
                            <tr>
                                <th>Medicine Name</th>
                                <th>Category</th>
                                <th>Available Package</th>
                                <th>Stock & Expiry</th>
                                <th>Price Range</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="medicineTableBody">
                            <!-- Medicine data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Billing Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-receipt"></i> Billing Section</h2>
                    </div>
                    <table id="billTable">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Size</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billItems">
                            <!-- Bill items will be added here dynamically -->
                        </tbody>
                    </table>

                    <!-- Total Amount Section -->
                    <div class="total-section">
                        <div class="total-card">
                            <div class="total-row">
                                <span class="total-label">Total Quantity:</span>
                                <span class="total-value" id="totalQuantity">0</span>
                            </div>
                            <div class="total-row final-total">
                                <span class="total-label">Total Amount:</span>
                                <span class="total-value rupee-symbol" id="totalAmount">0.00</span>
                            </div>
                            <div class="invoice-actions" style="margin-top: 20px;">
                                <button class="btn btn-success" onclick="redirectToInvoicePage()">
                                    <i class="fas fa-file-invoice"></i> Generate Bill
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inbox Toggle Button -->
    <div class="inbox-toggle" onclick="toggleInbox()">
        <i class="fas fa-bell"></i>
        <div class="inbox-badge" id="inboxBadge">0</div>
    </div>

    <!-- Inbox Container -->
    <div class="inbox-container" id="inboxContainer">
        <div class="inbox-header">
            <div class="inbox-title">Expiry Notifications</div>
            <div class="inbox-close" onclick="toggleInbox()">&times;</div>
        </div>
        <div class="inbox-content" id="inboxContent">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="stats-modal">
        <div class="stats-modal-content">
            <span class="close" onclick="closeStatsModal()">&times;</span>
            <h2><i class="fas fa-chart-bar"></i> Medicine Inventory Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMedicines">0</div>
                    <div class="stat-label">Total Medicines</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalVariants">0</div>
                    <div class="stat-label">Total Variants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalStock">0</div>
                    <div class="stat-label">Total Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="expiringSoon">0</div>
                    <div class="stat-label">Expiring Soon</div>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3>Medicine Categories</h3>
                <div id="categoryStats">
                    <!-- Category stats will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Medicine Modal -->
    <div id="medicineModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMedicineModal()">&times;</span>
            <h2 id="modalTitle"><i class="fas fa-pills"></i> Add New Medicine</h2>
            <div class="medicine-form-group">
                <label for="medName">Medicine Name</label>
                <input type="text" id="medName" class="form-control uppercase" placeholder="Enter medicine name" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="medicine-form-group">
                <label for="medCategory">Category</label>
                <input type="text" id="medCategory" class="form-control" placeholder="Click to select category" readonly onclick="showCategoryModal()">
            </div>
            <div class="medicine-form-group">
                <label>Pricing & Stock</label>
                <div id="pricingContainer">
                    <!-- Pricing inputs will be added here -->
                </div>
                <button class="btn btn-info" onclick="addPricingField()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Add Size
                </button>
            </div>
            <button class="btn btn-primary" onclick="saveMedicine()">
                <i class="fas fa-save"></i> Save Medicine
            </button>
            <button id="deleteMedicineBtn" class="btn" style="background: var(--danger); color: white; margin-left: 10px; display: none;" onclick="deleteMedicine()">
                <i class="fas fa-trash"></i> Delete Medicine
            </button>
        </div>
    </div>

    <!-- Category Selection Modal -->
    <div id="categoryModal" class="category-modal">
        <div class="category-modal-content">
            <span class="close" onclick="closeCategoryModal()">&times;</span>
            <h2>Select Category</h2>
            <div class="category-modal-option" onclick="selectCategory('ml/Ltr')">ml/Ltr</div>
            <div class="category-modal-option" onclick="selectCategory('gm/Kg')">gm/Kg</div>
            <div class="category-modal-option" onclick="selectCategory('Tab')">Tab</div>
            <div class="category-modal-option" onclick="selectCategory('Cap')">Cap</div>
        </div>
    </div>

    <!-- Size Selection Modal -->
    <div id="sizeModal" class="size-modal">
        <div class="size-modal-content">
            <span class="close" onclick="closeSizeModal()">&times;</span>
            <h2 id="sizeModalTitle">Select Size Type</h2>
            <div id="sizeOptions">
                <!-- Size options will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Variant Selection Modal -->
    <div id="variantModal" class="variant-modal">
        <div class="variant-modal-content">
            <span class="close" onclick="closeVariantModal()">&times;</span>
            <h2 id="variantModalTitle">Select Variant</h2>
            <div id="variantOptions">
                <!-- Variant options will be added here -->
            </div>
            <div id="quantitySelection" style="display: none; margin-top: 20px;">
                <h3>Select Quantity</h3>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                    <input type="number" id="selectedQuantity" class="form-control" value="1" min="1" style="width: 80px; text-align: center;">
                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                </div>
                <div style="margin-top: 10px;">
                    <p id="stockInfo">Available: 0</p>
                    <p id="expiryInfo">Expiry: N/A</p>
                    <p id="priceInfo">Price: ₹0</p>
                    <p id="totalPriceInfo">Total: ₹0</p>
                </div>
                <button class="btn btn-primary" onclick="addToBillWithVariant()" style="margin-top: 15px; width: 100%;">Add to Bill</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        // Medicine data structure
        let medicines = [];
        let billItems = [];
        let currentMedicineName = null;
        let selectedMedicine = null;
        let selectedVariant = null;
        let selectedQuantity = 1;
        let currentCategory = null;
        let currentPricingField = null;
        let selectedCategoryFilter = 'all';
        let currentUnit = '';
        let notifications = [];
        let defaultMedicines = [];
        let selectedUnit = '';
        let customerSelected = false;

        // Customer data for autocomplete
        const customers = [
            { name: 'Dr. Narendra Chalake', address: 'Mumbra, Thane', phone: '7738025850' },
            { name: 'Dr. Sunil Jadhav', address: 'Ramnagar, Dighagaon, Thane', phone: '9821572441' },
            { name: 'Dr. Swapnil Aher', address: 'M.B. Apartment, 1st Floor, Opp. Bardi Petrol Pump, Bapgaon', phone: '9702800404' },
            { name: 'Dr. Kailash Patil', address: 'Shahapur', phone: '9850083039' },
            { name: 'Dr. Shruti Inamdar', address: 'Badlapur', phone: '9004655132' },
            { name: 'Dr. Bharat Jain', address: 'Vasind, Shahapur', phone: '9226346034' },
            { name: 'Dr. Vaibhav Joshi', address: 'Flat No. A-2, Jiteesh CHS, , Bkbck road', phone: '9762751836' },
            { name: 'Dr. Amol Malave', address: 'Radha Residency, New D.P. Road, Badlapur', phone: '9762751836' },
            { name: 'Dr. Ujjwala Chavan', address: 'Khadakpada, Kalyan(West)', phone: '9323022928' },
            { name: 'Dr. Hemant Chavan', address: 'Badlapur(East)', phone: '9766995698' },
            { name: 'Dr. Shubhangi Bhatkhande', address: 'Rambaug, Kalyan(West)', phone: '' }
        ];

        // Format date to MM-YYYY
        function formatExpiryDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${year}`;
        }

        // Initialize the application
        async function initializeApp() {
            // Fetch medicines and notifications from the backend
            await fetchMedicines();
            await fetchNotifications();

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billDate').value = today;

            // Populate medicine table with default medicines
            selectDefaultMedicines();
            populateMedicineTable();

            // Update medicine count
            updateMedicineCount();

            // Update inbox badge
            updateInboxBadge();

            // Add event listener for search input
            document.getElementById('medicineSearch').addEventListener('input', function() {
                const clearBtn = document.getElementById('clearSearch');
                clearBtn.style.display = this.value ? 'flex' : 'none';
                searchMedicine();
            });

            // Add event listener for direct quantity input in variant modal
            document.getElementById('selectedQuantity').addEventListener('input', function() {
                if (selectedVariant) {
                    let val = parseInt(this.value);
                    if (isNaN(val) || val < 1) {
                        val = 1;
                    } else if (val > selectedVariant.stock) {
                        val = selectedVariant.stock;
                    }
                    this.value = val;
                    selectedQuantity = val;
                    document.getElementById('totalPriceInfo').textContent = `Total: ₹${selectedVariant.price * val}`;
                }
            });

            // Initialize customer dropdown
            document.getElementById('customerName').addEventListener('input', filterCustomerDropdown);

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.matches('#customerName') && !event.target.closest('.customer-dropdown')) {
                    document.getElementById('customerDropdown').classList.remove('active');
                }
            });
        }

        // Filter and show customer dropdown
        function filterCustomerDropdown() {
            const searchTerm = document.getElementById('customerName').value.toLowerCase();
            const customerDropdown = document.getElementById('customerDropdown');
            customerDropdown.innerHTML = '';

            // Filter customers based on search term
            const filteredCustomers = customers.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm)
            );

            // Populate dropdown with filtered customers
            if (filteredCustomers.length > 0) {
                filteredCustomers.forEach(customer => {
                    const option = document.createElement('div');
                    option.className = 'customer-option';
                    option.textContent = customer.name;
                    option.onclick = () => selectCustomer(customer.name, customer.address, customer.phone);
                    customerDropdown.appendChild(option);
                });
                customerDropdown.classList.add('active');
            } else {
                customerDropdown.classList.remove('active');
            }
        }

        // Select customer from dropdown
        function selectCustomer(name, address, phone) {
            document.getElementById('customerName').value = name;
            document.getElementById('customerAddress').value = address;
            document.getElementById('customerPhone').value = phone;
            document.getElementById('customerDropdown').classList.remove('active');
            customerSelected = true;
        }

        // Fetch medicines from the backend
        async function fetchMedicines() {
            try {
                const searchTerm = document.getElementById('medicineSearch').value.toUpperCase();
                const queryParams = new URLSearchParams({
                    search: searchTerm,
                    category: selectedCategoryFilter
                });
                const response = await fetch(`/api/medicines?${queryParams}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch medicines');
                }
                medicines = await response.json();
                selectDefaultMedicines();
                populateMedicineTable();
            } catch (error) {
                console.error('Error fetching medicines:', error);
                alert('Failed to load medicines. Please try again.');
            }
        }

        // Fetch notifications from the backend
        async function fetchNotifications() {
            try {
                const response = await fetch('/api/notifications');
                if (!response.ok) {
                    throw new Error('Failed to fetch notifications');
                }
                notifications = await response.json();
                populateInbox();
                updateInboxBadge();
            } catch (error) {
                console.error('Error fetching notifications:', error);
                alert('Failed to load notifications. Please try again.');
            }
        }

        // Menu selection function
        function selectMenu(menu) {
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (menu === 'inventory') {
                showStatsModal();
            } else if (menu === 'reports') {
                window.location.href = '/reports';
            } else if (menu === 'profit') {
                window.location.href = '/profit';
            } else if (menu === 'logout') {
                window.location.href = '/logout';
            }
        }

        // Update medicine count
        function updateMedicineCount() {
            const medicineCount = medicines.length;
            document.getElementById('medicineCount').textContent = medicineCount;
        }

        // Show stats modal
        function showStatsModal() {
            // Calculate stats
            const totalMedicines = medicines.length;
            const totalVariants = medicines.reduce((sum, medicine) => sum + medicine.variants.length, 0);
            const totalStock = medicines.reduce((sum, medicine) => {
                return sum + medicine.variants.reduce((vSum, variant) => vSum + variant.stock, 0);
            }, 0);

            // Count expiring soon (within 30 days)
            const today = new Date();
            const expiringSoon = medicines.reduce((count, medicine) => {
                return count + medicine.variants.filter(variant => {
                    if (!variant.expiry) return false;
                    const expiryDate = new Date(variant.expiry);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 30 && diffDays >= 0;
                }).length;
            }, 0);

            // Update stats in modal
            document.getElementById('totalMedicines').textContent = totalMedicines;
            document.getElementById('totalVariants').textContent = totalVariants;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('expiringSoon').textContent = expiringSoon;

            // Calculate category stats
            const categoryStats = {};
            medicines.forEach(medicine => {
                if (!categoryStats[medicine.category]) {
                    categoryStats[medicine.category] = 0;
                }
                categoryStats[medicine.category]++;
            });

            // Display category stats
            const categoryStatsContainer = document.getElementById('categoryStats');
            categoryStatsContainer.innerHTML = '';

            for (const category in categoryStats) {
                const statRow = document.createElement('div');
                statRow.style.display = 'flex';
                statRow.style.justifyContent = 'space-between';
                statRow.style.padding = '10px 0';
                statRow.style.borderBottom = '1px solid #eee';

                statRow.innerHTML = `
                    <div>${category}</div>
                    <div><strong>${categoryStats[category]}</strong> medicines</div>
                `;

                categoryStatsContainer.appendChild(statRow);
            }

            // Show modal
            document.getElementById('statsModal').style.display = 'block';
        }

        // Close stats modal
        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        // Select 4 random medicines for default display
        function selectDefaultMedicines() {
            // Create a copy of medicines array
            const shuffled = [...medicines];
            // Shuffle the array
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            // Take first 4
            defaultMedicines = shuffled.slice(0, 4);
        }

        // Get expiry status and color
        function getExpiryStatus(expiryDate) {
            if (!expiryDate) {
                return { status: 'valid', days: 'N/A', color: 'expiry-valid' };
            }
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { status: 'expired', days: diffDays, color: 'expiry-danger' };
            } else if (diffDays <= 6) {
                return { status: 'critical', days: diffDays, color: 'expiry-danger' };
            } else if (diffDays <= 30) {
                return { status: 'high', days: diffDays, color: 'expiry-warning' };
            } else if (diffDays <= 60) {
                return { status: 'medium', days: diffDays, color: 'expiry-warning' };
            } else if (diffDays <= 90) {
                return { status: 'low', days: diffDays, color: 'expiry-valid' };
            } else {
                return { status: 'valid', days: diffDays, color: 'expiry-valid' };
            }
        }

        // Update inbox badge count
        function updateInboxBadge() {
            const badge = document.getElementById('inboxBadge');
            badge.textContent = notifications.length;

            if (notifications.length > 0) {
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Toggle inbox visibility
        function toggleInbox() {
            const inbox = document.getElementById('inboxContainer');
            if (inbox.style.display === 'block') {
                inbox.style.display = 'none';
            } else {
                inbox.style.display = 'block';
            }
        }

        // Populate inbox with notifications
        function populateInbox() {
            const inboxContent = document.getElementById('inboxContent');
            inboxContent.innerHTML = '';

            if (notifications.length === 0) {
                inboxContent.innerHTML = '<p style="text-align: center; padding: 20px;">No notifications</p>';
                return;
            }

            // Sort notifications by priority (critical first)
            const sortedNotifications = notifications.sort((a, b) => {
                const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });

            sortedNotifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item notification-${notification.priority}`;
                notificationElement.innerHTML = `
                    <p>${notification.message}</p>
                    <div class="notification-date">${notification.date}</div>
                `;
                inboxContent.appendChild(notificationElement);
            });
        }

        // Populate medicine table
        function populateMedicineTable() {
            const tableBody = document.getElementById('medicineTableBody');
            tableBody.innerHTML = '';

            const searchTerm = document.getElementById('medicineSearch').value.toUpperCase();
            const showAll = searchTerm.length > 0 || selectedCategoryFilter !== 'all';

            const medicinesToShow = showAll ? medicines : defaultMedicines;

            medicinesToShow.forEach((medicine, index) => {
                // Apply category filter
                if (selectedCategoryFilter !== 'all' && medicine.category !== selectedCategoryFilter) {
                    return;
                }

                // Apply search filter
                if (searchTerm && medicine.name.toUpperCase().indexOf(searchTerm) === -1) {
                    return;
                }

                const row = document.createElement('tr');

                // Get available sizes
                const sizes = medicine.variants.map(v => v.size).join(', ');

                // Get stock information
                const totalStock = medicine.variants.reduce((sum, variant) => sum + variant.stock, 0);

                // Get earliest expiry date and status
                const validExpiries = medicine.variants.filter(v => v.expiry).map(v => new Date(v.expiry));
                let formattedExpiry = 'No Expiry';
                let expiryStatus = { color: 'expiry-valid' };
                if (validExpiries.length > 0) {
                    const earliestExpiry = new Date(Math.min.apply(null, validExpiries));
                    formattedExpiry = formatExpiryDate(earliestExpiry.toISOString().split('T')[0]);
                    expiryStatus = getExpiryStatus(earliestExpiry.toISOString().split('T')[0]);
                }

                // Get price range
                const prices = medicine.variants.map(v => v.price);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const priceRange = `₹${minPrice} - ₹${maxPrice}`;

                row.innerHTML = `
                    <td>${medicine.name}</td>
                    <td>${medicine.category}</td>
                    <td>${sizes}</td>
                    <td>
                        <div class="stock-expiry">
                            <span>${totalStock}</span>
                            <span class="expiry-date ${expiryStatus.color}">Exp: ${formattedExpiry}</span>
                        </div>
                    </td>
                    <td>${priceRange}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectMedicine(${index})">Add to Bill</button>
                        <button class="btn" style="background: var(--success); color: white;" onclick="editMedicine(${index})">Edit</button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Medicine search function
        async function searchMedicine() {
            await fetchMedicines();
        }

        // Clear search input
        function clearSearch() {
            document.getElementById('medicineSearch').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            // Reset the table to show default medicines
            selectDefaultMedicines();
            populateMedicineTable();
        }

        // Toggle category dropdown
        function toggleCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('active');
        }

        // Filter by category
        async function filterByCategory(category) {
            selectedCategoryFilter = category;
            await fetchMedicines();

            // Close dropdown
            document.getElementById('categoryDropdown').classList.remove('active');
        }

        // Select medicine for billing
        function selectMedicine(index) {
            const searchTerm = document.getElementById('medicineSearch').value;
            const showAll = searchTerm.length > 0 || selectedCategoryFilter !== 'all';
            const medicinesToUse = showAll ? medicines : defaultMedicines;

            selectedMedicine = medicinesToUse[index];
            document.getElementById('variantModalTitle').textContent = `Select Variant - ${selectedMedicine.name}`;

            // Populate variant options
            const variantOptions = document.getElementById('variantOptions');
            variantOptions.innerHTML = '';

            selectedMedicine.variants.forEach((variant, i) => {
                let expiryDate = 'N/A';
                let expiryStatus = { color: 'expiry-valid' };
                if (variant.expiry) {
                    expiryDate = formatExpiryDate(variant.expiry);
                    expiryStatus = getExpiryStatus(variant.expiry);
                }

                const option = document.createElement('div');
                option.className = 'variant-option';
                option.innerHTML = `
                    <strong>${variant.size}</strong> - ₹${variant.price}
                    <div>Stock: ${variant.stock} | <span class="${expiryStatus.color}">Expiry: ${expiryDate}</span></div>
                `;
                option.onclick = () => selectVariant(i);
                variantOptions.appendChild(option);
            });

            // Show modal
            document.getElementById('variantModal').style.display = 'block';
        }

        // Select variant
        function selectVariant(index) {
            selectedVariant = selectedMedicine.variants[index];
            selectedQuantity = 1;

            // Update UI
            document.getElementById('selectedQuantity').value = selectedQuantity;
            document.getElementById('stockInfo').textContent = `Available: ${selectedVariant.stock}`;

            let expiryDate = 'N/A';
            let expiryStatus = { color: 'expiry-valid' };
            if (selectedVariant.expiry) {
                expiryDate = formatExpiryDate(selectedVariant.expiry);
                expiryStatus = getExpiryStatus(selectedVariant.expiry);
            }
            document.getElementById('expiryInfo').innerHTML = `Expiry: <span class="${expiryStatus.color}">${expiryDate}</span>`;

            document.getElementById('priceInfo').textContent = `Price: ₹${selectedVariant.price}`;
            document.getElementById('totalPriceInfo').textContent = `Total: ₹${selectedVariant.price * selectedQuantity}`;

            // Show quantity selection
            document.getElementById('quantitySelection').style.display = 'block';
        }

        // Change quantity
        function changeQuantity(change) {
            const newQuantity = selectedQuantity + change;
            if (newQuantity > 0 && newQuantity <= selectedVariant.stock) {
                selectedQuantity = newQuantity;
                document.getElementById('selectedQuantity').value = selectedQuantity;
                document.getElementById('totalPriceInfo').textContent = `Total: ₹${selectedVariant.price * selectedQuantity}`;
            }
        }

        // Add to bill with selected variant
        function addToBillWithVariant() {
            // Check if item already exists in bill
            const existingItemIndex = billItems.findIndex(item =>
                item.name === selectedMedicine.name && item.size === selectedVariant.size
            );

            if (existingItemIndex !== -1) {
                // Item exists, increase quantity if stock allows
                const item = billItems[existingItemIndex];
                const newQuantity = item.quantity + selectedQuantity;
                if (newQuantity <= selectedVariant.stock) {
                    item.quantity = newQuantity;
                    item.total = newQuantity * item.price;
                } else {
                    alert(`Only ${selectedVariant.stock} items available in stock!`);
                    return;
                }
            } else {
                // Add new item
                billItems.push({
                    name: selectedMedicine.name,
                    size: selectedVariant.size,
                    mrp: selectedVariant.price,
                    price: selectedVariant.price,
                    quantity: selectedQuantity,
                    total: selectedVariant.price * selectedQuantity,
                    expiry: selectedVariant.expiry
                });
            }

            updateBillTable();
            closeVariantModal();
        }

        // Close variant modal
        function closeVariantModal() {
            document.getElementById('variantModal').style.display = 'none';
            document.getElementById('quantitySelection').style.display = 'none';
            selectedMedicine = null;
            selectedVariant = null;
        }

        // Update bill table
        function updateBillTable() {
            const billTable = document.getElementById('billItems');
            const totalQuantityElement = document.getElementById('totalQuantity');
            const totalAmountElement = document.getElementById('totalAmount');

            // Clear current table
            billTable.innerHTML = '';

            let totalQuantity = 0;
            let subtotalAmount = 0;

            // Add items to table
            billItems.forEach((item, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.size}</td>
                    <td>
                        <input type="number" class="form-control" value="${item.quantity}" min="1"
                               style="width: 80px;" oninput="updateQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <span class="rupee-symbol" style="margin-right: 5px;"></span>
                            <input type="number" class="form-control" value="${item.price}" style="width: 80px;"
                                   oninput="updatePrice(${index}, this.value)">
                        </div>
                    </td>
                    <td class="rupee-symbol">${item.total.toFixed(2)}</td>
                    <td>
                        <button class="btn" style="background: var(--danger); color: white;"
                                onclick="removeFromBill(${index})">Remove</button>
                    </td>
                `;

                billTable.appendChild(row);
                totalQuantity += item.quantity;
                subtotalAmount += item.total;
            });

            // Update total values (no tax)
            totalQuantityElement.textContent = totalQuantity;
            totalAmountElement.textContent = subtotalAmount.toFixed(2);
        }

        // Update item quantity
        function updateQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity > 0) {
                // Find the medicine and variant to check stock
                const item = billItems[index];
                const medicine = medicines.find(m => m.name === item.name);
                const variant = medicine.variants.find(v => v.size === item.size);

                if (quantity <= variant.stock) {
                    item.quantity = quantity;
                    item.total = quantity * item.price;
                    updateBillTable();
                } else {
                    alert(`Only ${variant.stock} items available in stock!`);
                    // Reset to previous value
                    document.querySelector(`#billItems tr:nth-child(${index+1}) input[type="number"]:first-of-type`).value = item.quantity;
                }
            }
        }

        // Update item price manually
        function updatePrice(index, newPrice) {
            const price = parseFloat(newPrice);
            if (price > 0) {
                billItems[index].price = price;
                billItems[index].total = price * billItems[index].quantity;
                updateBillTable();
            } else {
                alert('Price must be greater than 0');
                // Reset to previous value
                const priceInputs = document.querySelectorAll(`#billItems tr:nth-child(${index+1}) input[type="number"]`);
                priceInputs[1].value = billItems[index].price;
            }
        }

        // Remove item from bill
        function removeFromBill(index) {
            billItems.splice(index, 1);
            updateBillTable();
        }

        // Redirect to invoice page
        function redirectToInvoicePage() {
            if (billItems.length === 0) {
                alert('Please add at least one medicine to the bill.');
                return;
            }

            const customerName = document.getElementById('customerName').value || 'Walk-in Customer';
            const customerAddress = document.getElementById('customerAddress').value || 'N/A';
            const customerPhone = document.getElementById('customerPhone').value || 'N/A';
            const gstNo = document.getElementById('gstNo').value || 'N/A';
            const panNo = document.getElementById('panNo').value || 'N/A';
            const billDate = document.getElementById('billDate').value || new Date().toISOString().split('T')[0];

            // Prepare the bill data
            const billData = {
                customerName: customerName,
                customerAddress: customerAddress,
                customerPhone: customerPhone,
                gstNo: gstNo,
                panNo: panNo,
                billDate: billDate,
                items: billItems
            };

            // Store the bill data in sessionStorage
            sessionStorage.setItem('billData', JSON.stringify(billData));

            // Save to server via API
            fetch('/save-bill-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(billData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Bill data saved to server:', data);
                // Redirect to the invoice page using Flask route
                window.location.href = '/invoice_pdf';
            })
            .catch(error => {
                console.error('Error saving bill data to server:', error);
                // Fallback: redirect to invoice page anyway
                window.location.href = '/invoice_pdf';
            });
        }

        // Open add medicine modal
        function openAddMedicineModal() {
            currentMedicineName = null;
            document.getElementById('modalTitle').textContent = 'Add New Medicine';
            document.getElementById('medName').value = '';
            document.getElementById('medCategory').value = '';
            currentCategory = null;
            selectedUnit = '';

            // Clear pricing container
            const pricingContainer = document.getElementById('pricingContainer');
            pricingContainer.innerHTML = '';

            // Hide delete button
            document.getElementById('deleteMedicineBtn').style.display = 'none';

            // Show modal
            document.getElementById('medicineModal').style.display = 'block';
        }

        // Show category selection modal
        function showCategoryModal() {
            document.getElementById('categoryModal').style.display = 'block';
        }

        // Close category modal
        function closeCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
        }

        // Select category
        function selectCategory(category) {
            document.getElementById('medCategory').value = category;
            currentCategory = category;

            // Clear existing pricing fields and add a new one configured for the category
            const pricingContainer = document.getElementById('pricingContainer');
            pricingContainer.innerHTML = '';
            addPricingField();

            closeCategoryModal();
        }



        // Show size selection modal
        function showSizeModal(pricingField) {
            // For Tab and Cap categories, don't show size modal
            if (currentCategory === 'Tab' || currentCategory === 'Cap') {
                return;
            }

            currentPricingField = pricingField;
            document.getElementById('sizeModalTitle').textContent = `Select Size Type - ${currentCategory}`;

            const sizeOptions = document.getElementById('sizeOptions');
            sizeOptions.innerHTML = '';

            // Add size options based on category
            if (currentCategory === 'ml/Ltr') {
                sizeOptions.innerHTML = `
                    <div class="size-modal-option" onclick="selectSize('ml')">ml</div>
                    <div class="size-modal-option" onclick="selectSize('Ltr')">Ltr</div>
                `;
            } else if (currentCategory === 'gm/Kg') {
                sizeOptions.innerHTML = `
                    <div class="size-modal-option" onclick="selectSize('gm')">gm</div>
                    <div class="size-modal-option" onclick="selectSize('Kg')">Kg</div>
                `;
            }

            document.getElementById('sizeModal').style.display = 'block';
        }

        // Close size modal
        function closeSizeModal() {
            document.getElementById('sizeModal').style.display = 'none';
        }

        // Select size
        function selectSize(sizeType) {
            currentUnit = sizeType;
            const sizeInputContainer = currentPricingField.querySelector('.size-input-container');

            // Create unit indicator if it doesn't exist
            let unitSpan = sizeInputContainer.querySelector('.size-unit');
            if (!unitSpan) {
                unitSpan = document.createElement('span');
                unitSpan.className = 'size-unit';
                sizeInputContainer.appendChild(unitSpan);
            }

            unitSpan.textContent = sizeType;

            // Set the input placeholder to indicate the unit
            const sizeInput = sizeInputContainer.querySelector('.size-input');
            sizeInput.placeholder = `Enter size in ${sizeType}`;

            // Set focus to the input field
            sizeInput.focus();

            closeSizeModal();
        }

        // Add pricing field
        function addPricingField() {
            const pricingContainer = document.getElementById('pricingContainer');
            const pricingField = document.createElement('div');
            pricingField.className = 'pricing-field';

            let placeholderText = '';
            let hasOnClick = true;
            let sizeInputHtml = '<input type="text" class="form-control size-input" placeholder="';

            if (currentCategory === 'Tab' || currentCategory === 'Cap') {
                placeholderText = 'Enter QTY';
                hasOnClick = false;
            } else {
                placeholderText = 'Click to select size';
            }

            sizeInputHtml += placeholderText;
            sizeInputHtml += '"';

            if (hasOnClick) {
                sizeInputHtml += ' onclick="showSizeModal(this.parentNode.parentNode)"';
            }
            sizeInputHtml += '>';

            pricingField.innerHTML = `
                <div class="size-input-container" style="flex: 1;">
                    ${sizeInputHtml}
                </div>
                <input type="number" class="form-control" placeholder="Price" style="flex: 1;">
                <input type="number" class="form-control" placeholder="Stock" style="flex: 1;">
                <input type="date" class="form-control" placeholder="Expiry Date (Optional)" style="flex: 1;">
                <button class="btn" style="background: var(--danger); color: white;" onclick="removePricingField(this)">Remove</button>
            `;

            pricingContainer.appendChild(pricingField);

            // If category is Tab or Cap, automatically set the unit
            if (currentCategory === 'Tab' || currentCategory === 'Cap') {
                const unit = currentCategory === 'Tab' ? 'Tab' : 'Cap';
                const sizeInputContainer = pricingField.querySelector('.size-input-container');

                let unitSpan = document.createElement('span');
                unitSpan.className = 'size-unit';
                unitSpan.textContent = unit;
                sizeInputContainer.appendChild(unitSpan);

                // Update the placeholder
                const sizeInput = sizeInputContainer.querySelector('.size-input');
                sizeInput.placeholder = 'Enter QTY';

                // Remove onclick if present
                sizeInput.onclick = null;
            }
        }

        // Remove pricing field
        function removePricingField(button) {
            button.closest('.pricing-field').remove();
        }

        // Close medicine modal
        function closeMedicineModal() {
            document.getElementById('medicineModal').style.display = 'none';
        }

        // Edit medicine
        function editMedicine(index) {
            const searchTerm = document.getElementById('medicineSearch').value;
            const showAll = searchTerm.length > 0 || selectedCategoryFilter !== 'all';
            const medicinesToUse = showAll ? medicines : defaultMedicines;

            const medicine = medicinesToUse[index];
            currentMedicineName = medicine.name;

            document.getElementById('modalTitle').textContent = 'Edit Medicine';
            document.getElementById('medName').value = medicine.name;
            document.getElementById('medCategory').value = medicine.category;
            currentCategory = medicine.category;

            // Clear pricing container and add fields with values
            const pricingContainer = document.getElementById('pricingContainer');
            pricingContainer.innerHTML = '';
            medicine.variants.forEach(variant => {
                addPricingFieldWithValues(variant.size, variant.price, variant.stock, variant.expiry);
            });

            // Show delete button
            document.getElementById('deleteMedicineBtn').style.display = 'inline-block';

            // Show modal
            document.getElementById('medicineModal').style.display = 'block';
        }

        // Add pricing field with values
        function addPricingFieldWithValues(size, price, stock, expiry) {
            const pricingContainer = document.getElementById('pricingContainer');
            const pricingField = document.createElement('div');
            pricingField.className = 'pricing-field';

            // Extract unit and value from size
            let unit = '';
            let value = size;

            if (size.includes('gm')) {
                unit = 'gm';
                value = size.replace('gm', '');
            } else if (size.includes('Kg')) {
                unit = 'Kg';
                value = size.replace('Kg', '');
            } else if (size.includes('ml')) {
                unit = 'ml';
                value = size.replace('ml', '');
            } else if (size.includes('Ltr')) {
                unit = 'Ltr';
                value = size.replace('Ltr', '');
            } else if (size.includes('Tab')) {
                unit = 'Tab';
                value = size.replace(' Tab', '');
            } else if (size.includes('Cap')) {
                unit = 'Cap';
                value = size.replace(' Cap', '');
            }

            let hasOnClick = currentCategory !== 'Tab' && currentCategory !== 'Cap';
            let sizeInputHtml = `<input type="text" class="form-control size-input" value="${value}"`;
            if (hasOnClick) {
                sizeInputHtml += ' onclick="showSizeModal(this.parentNode.parentNode)"';
            }
            sizeInputHtml += '>';

            pricingField.innerHTML = `
                <div class="size-input-container" style="flex: 1;">
                    <span class="size-unit">${unit}</span>
                    ${sizeInputHtml}
                </div>
                <input type="number" class="form-control" value="${price}" style="flex: 1;">
                <input type="number" class="form-control" value="${stock}" style="flex: 1;">
                <input type="date" class="form-control" value="${expiry || ''}" placeholder="Expiry Date (Optional)" style="flex: 1;">
                <button class="btn" style="background: var(--danger); color: white;" onclick="removePricingField(this)">Remove</button>
            `;

            pricingContainer.appendChild(pricingField);

            // For Tab/Cap, ensure no onclick and placeholder
            if (currentCategory === 'Tab' || currentCategory === 'Cap') {
                const sizeInput = pricingField.querySelector('.size-input');
                sizeInput.onclick = null;
                sizeInput.placeholder = 'Enter QTY';
            }
        }

        // Save medicine with backend call
        async function saveMedicine() {
            const name = document.getElementById('medName').value.trim();
            const category = document.getElementById('medCategory').value.trim();

            if (!name || !category) {
                alert('Please fill medicine name and select a category.');
                return;
            }

            // Smart validation: Ensure category is one of the allowed
            const allowedCategories = ['ml/Ltr', 'gm/Kg', 'Tab', 'Cap'];
            if (!allowedCategories.includes(category)) {
                alert('Please select a valid category from the dropdown.');
                return;
            }

            // Get pricing data with smart validation
            const pricingFields = document.querySelectorAll('.pricing-field');
            const variants = [];
            let hasValidVariants = false;

            for (let field of pricingFields) {
                const sizeContainer = field.querySelector('.size-input-container');
                const unitSpan = sizeContainer.querySelector('.size-unit');
                const sizeInput = sizeContainer.querySelector('input[type="text"]');
                const priceInput = field.querySelectorAll('input[type="number"]')[0];
                const stockInput = field.querySelectorAll('input[type="number"]')[1];
                const expiryInput = field.querySelector('input[type="date"]');

                const sizeValue = sizeInput.value.trim();
                const priceValue = parseFloat(priceInput.value);
                const stockValue = parseInt(stockInput.value);

                // Smart logic: Validate size is numeric for non-Tab/Cap, price > 0, stock >= 0
                if (sizeValue && !isNaN(priceValue) && priceValue > 0 && !isNaN(stockValue) && stockValue >= 0) {
                    let fullSize = '';
                    if (unitSpan && unitSpan.textContent) {
                        const unit = unitSpan.textContent;
                        if (category === 'Tab' || category === 'Cap') {
                            fullSize = `${sizeValue} ${unit}`;
                        } else {
                            // Validate size is numeric
                            if (isNaN(parseFloat(sizeValue))) {
                                alert(`Invalid size value "${sizeValue}" for variant. Please enter a number.`);
                                return;
                            }
                            fullSize = `${sizeValue}${unit}`;
                        }
                    } else {
                        alert('Please select a size unit for the variant.');
                        return;
                    }

                    variants.push({
                        size: fullSize,
                        price: priceValue,
                        stock: stockValue,
                        expiry: expiryInput.value || null // Optional, but smart: if stock > 0 and no expiry, warn
                    });

                    // Smart check: If stock > 0 and no expiry, add warning
                    if (stockValue > 0 && !expiryInput.value) {
                        console.warn(`Variant ${fullSize} has stock but no expiry date. Consider adding one.`);
                    }

                    hasValidVariants = true;
                }
            }

            if (!hasValidVariants || variants.length === 0) {
                alert('Please add at least one valid variant with numeric size (where applicable), price > 0, and stock >= 0.');
                return;
            }

            // Smart algorithm: Deduplicate variants by size (prevent duplicates)
            const uniqueVariants = variants.filter((variant, idx, self) =>
                idx === self.findIndex(v => v.size === variant.size)
            );
            if (uniqueVariants.length !== variants.length) {
                alert('Duplicate sizes detected. Only unique sizes are saved.');
            }

            // Create medicine object
            const medicineData = {
                name: name.toUpperCase(),
                category: category,
                variants: uniqueVariants
            };

            try {
                // Always POST for both add and update (backend handles upsert by name)
                const response = await fetch('/api/medicines', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medicineData)
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.statusText}`);
                }

                // Refetch updated data
                await fetchMedicines();
                await fetchNotifications(); // Refetch notifications for expiry checks

                // Close modal
                closeMedicineModal();

                alert('Medicine saved successfully!');
            } catch (error) {
                console.error('Error saving medicine:', error);
                alert(`Failed to save medicine: ${error.message}`);
            }
        }

        // Delete medicine with backend call
        async function deleteMedicine() {
            if (!currentMedicineName) {
                alert('No medicine selected for deletion.');
                return;
            }

            if (confirm('Are you sure you want to delete this medicine? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/medicines/${encodeURIComponent(currentMedicineName)}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.statusText}`);
                    }

                    // Refetch updated data
                    await fetchMedicines();
                    await fetchNotifications();

                    closeMedicineModal();
                    alert('Medicine deleted successfully!');
                } catch (error) {
                    console.error('Error deleting medicine:', error);
                    alert(`Failed to delete medicine: ${error.message}`);
                }
            }
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.category-btn')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown.classList.contains('active')) {
                    dropdown.classList.remove('active');
                }
            }

            if (!event.target.matches('#customerName')) {
                document.getElementById('customerDropdown').classList.remove('active');
            }

            // Close modals when clicking outside
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>